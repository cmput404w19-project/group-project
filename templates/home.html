{% extends 'base.html' %}


{% block title %}Home{% endblock %}

{% block content %}
{% if user.is_authenticated %}
  <!-- Page Container -->
  <div class="w3-container w3-content" style="max-width:1400px;margin-top:30px">
    <!-- The Grid -->
    <div class="w3-row">
      <!-- Left Column -->
      <div class="w3-col m3">
        <!-- Profile -->
        <div class="w3-card w3-round w3-white" style="margin-bottom: 1em">
          <div class="w3-container">
            <h4 class="w3-center" style="font-family:Muli; font-size: 1.5em">{{ userprofile.displayName }}</h4>
            <br>
            <div class="btn-group btn-group-justified">
              <a href="{% url 'logout' %}" class="btn btn-default">logout</a>
              <a href="{% url 'password_reset' %}" class="btn btn-default">reset password</a>
            </div>
            <hr>
            <div class="w3-center">
              <p><a href="{% url 'render_post' %}" class="btn btn-default">Make Post</a></p>
            </div>
          </div>
        </div>   <!--Profile End-->
      </div>  <!--Left Column End-->

      <!-- Middle Column -->
      <div id="MiddleColumn" class="w3-col m9" style="position:relative">
        <!--Posts-->




        <!--Posts Ends-->
      </div> <!-- End Middle Column -->
    </div> <!--Grid End-->
  </div> <!--Page Container End-->
{% endif %}

<!-- Following will be the JavaScript that create the views for Posts -->
<script type="text/javascript">


  function showInMarkdown(){
      //type = document.getElementById("contentType").innerHTML;
      //alert(type)
      var list = document.getElementsByClassName("toMarkdown");
      var converter = new showdown.Converter();
      for (key of list){
          //alert(key.innerHTML)
          key.innerHTML = converter.makeHtml(key.innerHTML);
      }
      //alert(text)
      //var html = converter.makeHtml(text);
      //document.getElementById("toMarkdown").innerHTML = html;
  }


  // send a GET request to server API for Post data (in JSON format)
  function getPostData(url){
    $.ajax({
      type: 'GET',
      url: url,
      success: function(author_post_response){
        console.log(author_post_response);
        $.each(author_post_response.posts, function(i, post){
          // console.log(post);
          // following would be creating elements and render them

          var Post1stOutterDiv = document.createElement("div");
          // var br = document.createElement("br");
          Post1stOutterDiv.classList.add("w3-container");
          Post1stOutterDiv.classList.add("w3-card");
          Post1stOutterDiv.classList.add("w3-white");
          Post1stOutterDiv.classList.add("w3-round");
          Post1stOutterDiv.classList.add("post1st");
          // https://www.w3schools.com/jsref/prop_html_id.asp
          // w3school
          Post1stOutterDiv.id = post.id;
          Post1stOutterDiv.append(generate_br());

          var Post2ndOutterDiv = document.createElement("div");
          Post2ndOutterDiv.classList.add("Post");

          var userprofile_name_a = document.createElement("a");
          userprofile_name_a.classList.add("a-dec2");
          userprofile_name_a.classList.add("post-author-text");
          userprofile_name_a.style.fontSize = "1.5em";  // over write font size..
          //userprofile_name_a.href = "/author/"+post.author.id;
          userprofile_name_a.href = "/accounts/profile";
          userprofile_name_a.innerHTML = post.author.displayName;
          userprofile_name_a.id = "user_profile";

          var Post3rdDiv = document.createElement("div");
          var Post3rdDiv_spanTitle = document.createElement("span");
          Post3rdDiv_spanTitle.classList.add("span-a");
          Post3rdDiv_spanTitle.style = "font-size: 1.3em;font-weight: bold;";
          Post3rdDiv_spanTitle.innerHTML = post.title;
          var Post3rdDiv_spanPublishTime = document.createElement("span");
          Post3rdDiv_spanPublishTime.classList.add("span-a");
          Post3rdDiv_spanPublishTime.classList.add("post3rddiv_spanPublishTime");
          // convert time to time zone specific in client area standard
          Post3rdDiv_spanPublishTime.innerHTML = new Date(post.published);

          var new_hr = document.createElement("hr");
          new_hr.classList.add("w3-clear");


          // check for confidential authentication
          // if the current user is indeed the user who made this post
          // show the button for Editing and Deleting the post



          if ("{{userprofile.author_id}}"==post.author.id){
            var DeleteprofileForm = document.createElement("form");
            //referenced answered by v1k45 from https://stackoverflow.com/questions/36131472/django-csrf-token-with-js
            var csrf = document.createElement("input");
            csrf.setAttribute("type","hidden");
            csrf.setAttribute("name","csrfmiddlewaretoken");
            csrf.setAttribute("value","{{ csrf_token }}");
            DeleteprofileForm.appendChild(csrf);


            DeleteprofileForm.method = "POST";
            DeleteprofileForm.action = generete_some_url(post.id);
            var DeleteButtonDiv = document.createElement("div");
            var DeleteButton = document.createElement("button");
            DeleteButton.classList.add("btn")
            DeleteButton.classList.add("btn-default")
            DeleteButton.classList.add("btn-primary")
            DeleteButton.innerHTML = "Delete";
            //DeleteButton.classList.add("btn btn-default");
            //DeleteButton.classList.add("btn btn-primary");
            DeleteButtonDiv.appendChild(DeleteButton);
            DeleteprofileForm.appendChild(DeleteButtonDiv);
          }


          ////this shows plaintext description
          Post3rdDiv.appendChild(generate_br());
          if (post.contentType === "text/plain"){
            var Post3rdDiv_spanContent = document.createElement("h4");
            //Post3rdDiv_spanContent.classList.add("span-a");
            Post3rdDiv_spanContent.classList.add("Post3rdDiv_spanContent");
            Post3rdDiv_spanContent.innerHTML = post.content;

          }
          else if(post.contentType==="text/markdown"){
            var markdownText = document.createElement("p");
            markdownText.classList.add("toMarkdown");
            markdownText.innerHTML = post.content;

          }


          else if(post.contentType ==="image/png;base64" || post.contentType ==="image/jpeg;base64"){
            var meta1 = document.createElement("meta");
            meta1.id = "media_url";
            meta1.name = "media_url";
            meta1.content = post.image64;

            var imageshow = document.createElement("img");
            imageshow.id = "image";
            imageshow.style = "display:inline";
            imageshow.src = post.image64;
            imageshow.width = 500;
            imageshow.onerror = "this.style.display='none'";
            //loadImage();
          }

          var description = document.createElement("p");
          description.innerHTML = "Description: " + post.description;
          description.style = "color:#c0c4c3";

          var postID = document.createElement("p");
          postID.innerHTML = "postID: " + post.id;
          postID.style = "color:#c0c4c3";

          var testcomment = document.createElement("p");
          testcomment.innerHTML = post.title;

          ///this shows comment button and input

          var PostCommentInput = document.createElement("input");
          PostCommentInput.id = "input" + post.id;
          var PostCommentButton = document.createElement("button");
          PostCommentButton.innerHTML = "Comment";
          PostCommentButton.onclick=function(){
              addComment(post, "{{userprofile.author_id}}", "{{userprofile.host}}",
              "{{userprofile.displayName}}", "{{userprofile.url}}", "{{userprofile.github}}")
              document.location.reload(0);
          } ;
          //alert("{{userprofile.author_id}}")



          Post2ndOutterDiv.appendChild(userprofile_name_a);
          Post3rdDiv.appendChild(Post3rdDiv_spanTitle);
          Post3rdDiv.appendChild(generate_br());
          Post3rdDiv.appendChild(Post3rdDiv_spanPublishTime);
          Post3rdDiv.appendChild(generate_br());

          Post2ndOutterDiv.appendChild(Post3rdDiv);

          if ("{{userprofile.author_id}}"==post.author.id) {
            Post2ndOutterDiv.appendChild(DeleteprofileForm);
          }

          Post2ndOutterDiv.appendChild(new_hr);

          if (post.contentType === "text/plain"){
            Post2ndOutterDiv.appendChild(Post3rdDiv_spanContent);
          }

          if (post.contentType === "text/markdown"){
            Post2ndOutterDiv.appendChild(markdownText);
          }

          if(post.contentType ==="image/png;base64" || post.contentType ==="image/jpeg;base64"){
            Post2ndOutterDiv.appendChild(meta1);
            Post2ndOutterDiv.appendChild(imageshow);

          }

          Post2ndOutterDiv.appendChild(description);
          Post2ndOutterDiv.appendChild(postID);

          // Post2ndOutterDiv.appendChild(testcomment)

          Post2ndOutterDiv.appendChild(PostCommentButton);
          Post2ndOutterDiv.appendChild(PostCommentInput);



          Post1stOutterDiv.appendChild(Post2ndOutterDiv);
          document.getElementById("MiddleColumn").appendChild(Post1stOutterDiv);
          showInMarkdown();
          // loadImage();
        });
      }
    });
  }
  //reference answered by kodmasin from https://stackoverflow.com/questions/1795701/django-reverse-for-javascript
  function generete_some_url(id){
    return "{% url 'deletepost' post_id=112233 %}".replace("112233", id);
  }

  function loadImage(){
      media_url = document.getElementById("media_url").getAttribute("content");
      //alert(media_url)
      image = document.getElementById("image")
      image.src = media_url;
      image.style.display = "inline";
  }

  function generate_br(){
    return document.createElement("br");
  }


      // Reference:
      // https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch
      function addComment(post, user_id, user_host, user_displayName, user_url, user_github){
          let content = document.getElementById("input"+post.id).value;
          // user who add comment
          // Reference:
          // Eric Herlitz
          // https://stackoverflow.com/questions/6042007/how-to-get-the-host-url-using-javascript-from-the-current-page
          // get current host
          //let protocol = location.protocol;
          //let slashes = protocol.concat("//");
          //let host = slashes.concat(window.location.hostname);
          //alert(host)
          //alert(user_host)
          //let post_host = post.author.host;

          //alert(user_id);
          //alert(user_host);
          //alert(user_displayName);
          //alert(user_url);
          //alert(user_github);
          //alert(content);
          if (content == ""){
              alert("Comment is Empty!")
          }
          else{
              //alert(content);
              //alert(post_id);
              let data = {
                  "query": "addComment",
                  "post": post.origin,
                  "comment":
                  {
                      "author":{
                          // ID of the author
                          "id": user_id,
                          "host": user_host + '/',
                          "displayName": user_displayName,
                          // url to the authors information
                          "url": user_url,
                          // HATEOS url for Github API
                          "github": user_github
                      },
                      "comment": content,
                      "contentType":"text/plain",
                      //"published":"2015-03-09T13:07:04+00:00",
                      //"id":"de305d54-75b4-431b-adb2-eb6b9e546013"
                  },

              };


              let url = "/posts/"+post.id+"/comment/";
              //alert(url);
              //alert(Cookies.get('csrftoken'));
              //alert(getToken());

              fetch(url,
              {
                  method: "POST",
                  body: JSON.stringify(data),

                  headers: {
                      "Content-Type": 'application/json',
                      "X-CSRFToken": getToken()

                  },
                  credentials: 'same-origin'
              }).then(res => res.json())
              .then(response => {
                  console.log('Success:', JSON.stringify(response));
                  document.getElementById("input"+post.id).value = "";
              })
              .catch(error => console.error('Error:', error));
          }
      }


      // Reference:
      // https://docs.djangoproject.com/en/2.1/ref/csrf/
      // Cookies.get('csrftoken') cannot be used
      function getToken() {
          var cookieValue = null;
          var name = "csrftoken"
          if (document.cookie && document.cookie !== '') {
              var cookies = document.cookie.split(';');
              for (var i = 0; i < cookies.length; i++) {
                  var cookie = jQuery.trim(cookies[i]);
                  // Does this cookie string begin with the name we want?
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
      }


  // function getAuthorData(url, userObject){
  //   $.ajax({
  //     type: 'GET',
  //     url: url,
  //     success: function(user, userObject){

  //     }
  //   });
  // }

  // call the function the send GET request for Post data


  getPostData("{{ author_post_api_url }}?size=10");

</script>



{% endblock %}
